### Asegúrate de tener:
### 1. Lambda corriendo en http://localhost:3000 (serverless offline)
### 2. Customers API corriendo en http://localhost:3001
### 3. Orders API corriendo en http://localhost:3002
### 4. Un customer y producto ya creados en las APIs

@baseUrl = http://localhost:3000
@customerId = e85709c6-5e48-4558-bed1-71be6b608501
@productId = 8d2a0166-2617-44d9-a22a-c8ed030e4e42



# Prueba Completa

### PASO 1: Crear Customer en Customers API
POST http://localhost:3001/customers
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXVzZXIiLCJuYW1lIjoiVGVzdCBVc2VyIiwiaWF0IjoxNzYxOTUyODI5fQ.p25XlVRQJBT4Bq85R-6j4Bnj5hY4-h-57P-QrsID7iA
Content-Type: application/json

{
  "name": "Test Customer para Lambda",
  "email": "lambda-test@example.com",
  "phone": "+1234567890"
}

### PASO 2: Crear Producto en Orders API
POST http://localhost:3002/products
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXVzZXIiLCJuYW1lIjoiVGVzdCBVc2VyIiwiaWF0IjoxNzYxOTUyODI5fQ.p25XlVRQJBT4Bq85R-6j4Bnj5hY4-h-57P-QrsID7iA
Content-Type: application/json

{
  "sku": "LAMBDA-TEST-001",
  "name": "Producto Test Lambda",
  "priceCents": 5000,
  "stock": 100
}

### PASO 3: Orquestar pedido CON idempotency_key
# El cliente genera un UUID y lo envía en cada request
# Si hay retry, enviar el MISMO UUID para evitar duplicados
POST {{baseUrl}}/orchestrate-order
Content-Type: application/json

{
  "customer_id": "{{customerId}}",
  "items": [
    {
      "product_id": "{{productId}}",
      "qty": 2
    }
  ],
  "idempotency_key": "client-uuid-123e4567-e89b-12d3-a456-426614174000"
}

### PASO 4: Retry con EL MISMO idempotency_key (debe devolver el mismo resultado)
# Ejecutar este request múltiples veces - debe devolver siempre el mismo resultado
POST {{baseUrl}}/orchestrate-order
Content-Type: application/json

{
  "customer_id": "{{customerId}}",
  "items": [
    {
      "product_id": "{{productId}}",
      "qty": 2
    }
  ],
  "idempotency_key": "client-uuid-123e4567-e89b-12d3-a456-426614174000"
}

# Verificación

### Verificar orden creada en Orders API
@orderId = d084178c-0fde-428b-b9c9-32f320d4e5d6

GET http://localhost:3002/orders/{{orderId}}
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXVzZXIiLCJuYW1lIjoiVGVzdCBVc2VyIiwiaWF0IjoxNzYxOTUyODI5fQ.p25XlVRQJBT4Bq85R-6j4Bnj5hY4-h-57P-QrsID7iA

### Verificar que el stock fue descontado
GET http://localhost:3002/products/{{productId}}
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXVzZXIiLCJuYW1lIjoiVGVzdCBVc2VyIiwiaWF0IjoxNzYxOTUyODI5fQ.p25XlVRQJBT4Bq85R-6j4Bnj5hY4-h-57P-QrsID7iA

### Verificar que la orden está en estado CONFIRMED
GET http://localhost:3002/orders?status=CONFIRMED
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0LXVzZXIiLCJuYW1lIjoiVGVzdCBVc2VyIiwiaWF0IjoxNzYxOTUyODI5fQ.p25XlVRQJBT4Bq85R-6j4Bnj5hY4-h-57P-QrsID7iA

